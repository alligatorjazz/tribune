<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tribune - Test - gay peo</title>
<link rel="stylesheet" href="/style.css">
</head>
<body>

<nav-bar></nav-bar>
<h1>here is a blog post !!</h1>
<article>
<p>i ~hate~ gay people</p>

<h1 id="i_love_gay_weee!!!!">i love gay weee!!!!</h1>

<h2 id="no.">no.</h2>

</article>


<script>const tribune_data = {
	posts: []
};

function isSameOrigin(urlString) {
    const url = new URL(urlString);
    const currentUrl = new URL(window.location.href);
    return (url.origin === currentUrl.origin);
}


tribune_data.posts["test"] = {"title":"gay peo","publish_date":"04/25/2001","description":"weeee","template":"default"}

function buildWidget(tag, path, inheritFrom) {
	const AquilaWidget = class extends HTMLElement {
		container;
		constructor() {
			super();
			this.container = document.createElement(inheritFrom ?? "div");
			this.container.style.visibility = "hidden"
			if (!path.startsWith("/")) {
				throw new Error("You can only load widgets from your own site for security reasons.");
			}

			if (!path.endsWith(".html")) {
				throw new Error("Widgets have to be html files.");
			}

			// load content
			fetch(path).then(res => {
				res
					.text()
					.then(text => {
						this.container.innerHTML = text
					})
					.catch(err => console.error(err))
					.finally(() => this.container.style.visibility = "visible")
			})
		}
		connectedCallback() {
			this.appendChild(this.container);
		}
	}
	customElements.define(tag, AquilaWidget)
}


function include(...elements) {
	for (const { tag, path } of elements) {
		if (tag === "blog-post") {
			// TODO: docs link here
			console.error("Sorry! You can't make a widget called blog-post - that's a reserved name. Check the docs for more details!")
		} else {
			buildWidget(tag, path)
		}
	}
}

class PostList extends HTMLElement {
	container;
	constructor() {
		super();
		this.container = document.createElement("ul");
		Object.entries(tribune_data.posts).map(([slug, data]) => {
			let content = document.createElement("a");
			content.href = "/posts/" + slug;

			if (data.title) {
				let title = document.createElement("div");
				title.className = "title";
				title.innerHTML = data.title;
				content.appendChild(title);
			}

			if (data.publish_date) {
				let date = document.createElement("div");
				date.className = "date";
				date.innerHTML = new Date(data.publish_date).toDateString();
				content.appendChild(date);
			}

			if (data.description) {
				let description = document.createElement("div");
				description.className = "description";
				description.innerHTML = data.description;
				content.appendChild(description);
			}

			this.container.appendChild(content);
		})
	}
	connectedCallback() {
		this.appendChild(this.container);
	}
}

customElements.define("post-list", PostList)

include({tag: 'test-widget', path: '/widgets/test-widget.html'})
include({tag: 'nav-bar', path: '/widgets/nav-bar.html'})</script>
</body>